<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Chat with AI</title>
    <!-- BootstrapのCDN -->
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .chat-container {
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            height: 400px;
            overflow-y: auto;
        }
        .message {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        .message.user {
            justify-content: flex-end;
        }
        .message.user .text {
            background-color: #dcf8c6;
            text-align: right;
        }
        .message.ai {
            justify-content: flex-start;
        }
        .message .text {
            max-width: 60%;
            padding: 10px;
            border-radius: 10px;
        }
        .message.user .text {
            border-top-right-radius: 0;
        }
        .message.ai .text {
            border-top-left-radius: 0;
            background-color: #f1f0f0;
        }
        .chat-input {
            width: 100%;
            border-top: 1px solid #ddd;
            padding: 10px;
        }
        .list-link {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 1000; /* 十分高い値を設定 */
        }
        .question-list {
            position: fixed;
            top: 0;
            left: -300px; /* 初期位置を左外に設定 */
            width: 300px;
            height: 100%;
            background-color: #f8f9fa;
            border-right: 1px solid #ddd;
            padding: 20px;
            overflow-y: auto;
            transition: left 0.3s ease; /* スライドアニメーション */
        }
        /* スライド表示状態のクラス */
        .question-list.open {
            left: 0; /* 表示時の位置 */
        }
        /* 質問ボタンの位置 */
        .show-questions-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <!-- リストページへのリンクを右上に追加 -->
        <div class="list-link">
            <a href="{% url 'pdf_list' %}" class="btn btn-secondary">リストページへ</a>
            <button id="show-questions-btn" class="btn btn-primary">質問リストを表示</button>
        </div>

        <!-- 上部にタイトルとアップロード日を表示 -->
        <div class="row mb-4">
            <div class="col-12">
                <h2>
                  <a href="{{ document.pdf_file.url }}" target="_blank">{{ document.title }}</a>
                </h2>
                <p>アップロード日: {{ document.uploaded_at }}</p>
                <!-- <h3>知りたいこと:</h3> -->
                <!-- <ul>
                    {% if document.point_1 %}
                        <li>{{ document.point_1 }}</li>
                    {% endif %}
                    {% if document.point_2 %}
                        <li>{{ document.point_2 }}</li>
                    {% endif %}
                    {% if document.point_3 %}
                        <li>{{ document.point_3 }}</li>
                    {% endif %}
                </ul> -->
            </div>
        </div>

        <!-- 左右に分けてレイアウト -->
        <div class="row">
            <!-- 左半分: PDFの要約 -->
            <div class="col-md-5">
                <h4>PDFの要約</h4>
                <div id="summary-container" class="summary" style="white-space: pre-wrap; border: 1px solid #ddd; padding: 10px; height: 400px; overflow-y: auto;">
                    {% for content in document.structed_toc.contents %}
                        <li>
                            <strong>タイトル:</strong> {{ content.title }}<br>
                            <strong>説明:</strong> {{ content.description }}
                        </li>
                    {% endfor %}
                    
                </div>
                <!-- 左からスライドする質問リスト -->
                <div id="question-list" class="question-list ">
                    <h4>質問リスト</h4>
                    <ul id="questions">
                        {% for question in document.question_list.questions %}
                            <li>
                                <strong>質問:</strong> {{ question.question }}<br>
                            </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>

            <!-- 右半分: AIとの対話スペース -->
            <div class="col-md-7 d-flex flex-column">
                <h4>AIとの対話</h4>
                <!-- チャットのコンテナ -->
                <div style="white-space: pre-wrap;" id="chat-container" class="chat-container mb-3">
                    <!-- メッセージが表示される領域 -->
                    <!-- ここにJavaScriptでメッセージを追加します -->
                </div>

                <!-- 入力フォーム -->
                <div class="chat-input mt-auto">
                    <form id="chat-form" class="d-flex">
                        <textarea id="user-input" class="form-control" rows="1" placeholder="質問を入力..."></textarea>
                        <button type="submit" class="btn btn-primary ml-2">送信</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- 隠しフィールドでDocument IDを保持 -->
        <input type="hidden" id="document-id" value="{{ document.id }}">
    </div>

    <!-- BootstrapのJSと依存するPopper.jsのCDN -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

    <!-- JavaScriptでフォームの送信処理 -->
    <script>
        // document.getElementById('summary-container').innerHTML = "{{ document.toc|escapejs }}";
        document.getElementById('chat-form').addEventListener('submit', function(event) {
            event.preventDefault(); // ページのリロードを防止

            // フォームからの入力内容を取得
            const userInput = document.getElementById('user-input').value.trim();
            const documentId = document.getElementById('document-id').value; // ドキュメントIDを取得

            if (userInput !== "") {
                // ユーザーの発言を表示
                addMessage(userInput, 'user');

                // APIにメッセージを送信
                fetch(`/test/chat-with-ai/${documentId}/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken') // CSRFトークンを送信
                    },
                    body: JSON.stringify({ message: userInput })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.response) {
                        // AIの応答を表示
                        addMessage(data.response, 'ai');
                    } else if (data.error) {
                        addMessage("エラー: " + data.error, 'ai');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    addMessage("エラーが発生しました。", 'ai');
                });

                // 入力エリアをクリア
                document.getElementById('user-input').value = "";
            }
        });

        function addMessage(message, sender) {
    const chatContainer = document.getElementById('chat-container');

    // メッセージの要素を作成
    const messageElement = document.createElement('div');
    messageElement.classList.add('message', sender);

    // AIの返答がHTML形式なのでinnerHTMLを使用
    const textElement = document.createElement('div');
    textElement.classList.add('text');

    if (sender === 'ai') {
        textElement.innerHTML = message;  // HTML形式をそのまま表示
    } else {
        textElement.textContent = message;  // ユーザーのメッセージはテキストとして表示
    }

    messageElement.appendChild(textElement);
    chatContainer.appendChild(messageElement);

    // チャットコンテナのスクロールを最下部に
    chatContainer.scrollTop = chatContainer.scrollHeight;
}

        // CSRFトークンを取得するための関数
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // ページ読み込み時に過去のチャット履歴を取得
        window.onload = function() {
            const documentId = document.getElementById('document-id').value; // ドキュメントIDを取得

            fetch(`/test/get-chat-history/${documentId}/`)
                .then(response => response.json())
                .then(data => {
                    const chatHistory = data.chat_history;
                    chatHistory.forEach(item => {
                        addMessage(item.message, item.role);
                    });
                });
        }
        document.getElementById("show-questions-btn").addEventListener("click", function() {
            // 質問リストの表示・非表示を切り替え
            const questionList = document.getElementById("question-list");
            questionList.classList.toggle("open"); // .openクラスを追加/削除
        });

        // 質問リストを表示する関数
        // function displayQuestions(questions) {
        //     const questionsContainer = document.getElementById("questions");
        //     questionsContainer.innerHTML = ''; // 既存の質問をクリア

        //     // 質問を順番に追加
        //     questions.forEach((question, index) => {
        //         const li = document.createElement("li");
        //         li.textContent = `${index + 1}. ${question}`;
        //         questionsContainer.appendChild(li);
        //     });
        // }

        // サンプルの質問データ（バックエンドから渡された質問を使う場合はこれを変更）
        // const questions = {{ document.question_list.questions|safe }};

        // 質問リストの表示を初期化
        // displayQuestions(questions);
    </script>
</body>
</html>
